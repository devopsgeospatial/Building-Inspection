<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Building Permit Compliance</title>
<style>
/* ── TOKENS ── */
:root{
  --bg:#0b1a2b; --bg1:#0f2236; --bg2:#132a42; --bg3:#1a3350;
  --bd:#1e3a54;  --bd2:#254460;
  --ink:#e0f0ff; --ink2:#9dc4e0; --ink3:#5a8aaa;
  --teal:#00d4b8; --sky:#48b4f0; --rose:#f06080;
  --gold:#f0c060; --lime:#78d890; --violet:#a080f0;
  --mono:'JetBrains Mono','Fira Mono','Courier New',monospace;
  --sans:'Inter','Segoe UI',system-ui,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);color:var(--ink);font-family:var(--sans);font-size:13px;overflow-x:hidden;}

/* ── MASTHEAD ── */
.masthead{
  background:linear-gradient(135deg,#071220 0%,#0b1a2b 60%,#0f2236 100%);
  border-bottom:2px solid var(--teal);
  padding:14px 32px 12px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;gap:24px;
}
.mh-left{display:flex;flex-direction:column;gap:2px;}
.mh-title{font-size:19px;font-weight:700;color:var(--ink);letter-spacing:-.2px;line-height:1.1;}
.mh-title em{color:var(--teal);font-style:normal;}
.mh-sub{font-family:var(--mono);font-size:8px;color:var(--ink3);letter-spacing:.8px;}

/* ── GLOBAL KPI STRIP ── */
.gkpi-row{display:flex;gap:12px;margin-left:auto;}
.gkpi{
  background:var(--bg2);border:1px solid var(--bd2);border-radius:8px;
  padding:9px 15px;min-width:120px;position:relative;overflow:hidden;
}
.gkpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.gkpi.c-teal::after{background:var(--teal);}
.gkpi.c-lime::after{background:var(--lime);}
.gkpi.c-rose::after{background:var(--rose);}
.gkpi.c-gold::after{background:var(--gold);}
.gkpi.c-sky::after{background:var(--sky);}
.gkpi-lbl{font-family:var(--mono);font-size:7px;letter-spacing:2px;color:var(--ink3);text-transform:uppercase;margin-bottom:4px;}
.gkpi-val{font-family:var(--mono);font-size:19px;font-weight:700;line-height:1;}
.gkpi-sub{font-family:var(--mono);font-size:7px;color:var(--ink3);margin-top:2px;}

/* ── STATUS ── */
.sbar{background:var(--bg1);border-bottom:1px solid var(--bd);padding:4px 32px;
  display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:8px;
  color:var(--ink3);letter-spacing:1px;transition:all .3s;min-height:22px;}
.sbar.gone{opacity:0;pointer-events:none;height:0;min-height:0;padding:0;border:none;}
.sdot{width:5px;height:5px;border-radius:50%;background:var(--teal);flex-shrink:0;animation:pulse 1.4s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

/* ── TABS ── */
.tab-bar{background:var(--bg1);border-bottom:2px solid var(--bd);
  padding:0 24px;display:flex;overflow-x:auto;
  position:sticky;top:56px;z-index:190;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab{padding:9px 16px 7px;font-family:var(--mono);font-size:9px;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--ink3);cursor:pointer;border:none;background:none;
  border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;
  display:flex;align-items:center;gap:6px;}
.tab:hover{color:var(--ink2);background:var(--bg2);}
.tab.on{color:var(--teal);border-bottom-color:var(--teal);background:var(--bg2);}
.tbadge{font-size:7px;padding:1px 5px;border-radius:8px;background:var(--bd2);color:var(--ink3);}
.tab.on .tbadge{background:var(--teal);color:var(--bg);}

/* ── MAIN ── */
.main{padding:24px 32px 60px;}
.city-view{display:none;}
.city-view.on{display:block;}

/* ── CITY HEADER ── */
.city-hd{display:flex;align-items:flex-start;gap:14px;margin-bottom:20px;
  padding-bottom:14px;border-bottom:1px solid var(--bd);}
.city-icon{width:40px;height:40px;border-radius:10px;display:flex;
  align-items:center;justify-content:center;flex-shrink:0;}
.city-name{font-size:24px;font-weight:700;color:var(--ink);line-height:1;}
.city-sub{font-family:var(--mono);font-size:8px;color:var(--ink3);letter-spacing:.8px;margin-top:3px;}
.hd-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.yr-bar{display:flex;}
.yr-btn{padding:5px 11px;font-family:var(--mono);font-size:8px;letter-spacing:1px;
  border:1px solid var(--bd2);background:var(--bg2);color:var(--ink3);cursor:pointer;transition:all .15s;}
.yr-btn:first-child{border-radius:4px 0 0 4px;}
.yr-btn:last-child{border-radius:0 4px 4px 0;border-left:none;}
.yr-btn.on{background:var(--teal);color:var(--bg);border-color:var(--teal);font-weight:700;}

/* ── KPI CARDS (image-2 style) ── */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.kcard{background:var(--bg1);border:1px solid var(--bd2);border-radius:10px;
  padding:15px 17px;position:relative;overflow:hidden;}
.kcard::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:10px 10px 0 0;}
.kcard.c-teal::after{background:var(--teal);}
.kcard.c-lime::after{background:var(--lime);}
.kcard.c-rose::after{background:var(--rose);}
.kcard.c-gold::after{background:var(--gold);}
.kcard.c-sky::after{background:var(--sky);}
.kcard-lbl{font-family:var(--mono);font-size:7px;letter-spacing:2px;color:var(--ink3);
  text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;gap:5px;}
.kcard-val{font-family:var(--mono);font-size:26px;font-weight:700;line-height:1;}
.kcard-sub{font-family:var(--mono);font-size:8px;color:var(--ink3);margin-top:4px;}

/* ── SECTION LABEL ── */
.sec-label{font-family:var(--mono);font-size:8px;letter-spacing:2px;text-transform:uppercase;
  color:var(--teal);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--bd);}

/* ── GRID ── */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:18px;}
.grid-21{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:18px;}
.grid-12{display:grid;grid-template-columns:1fr 2fr;gap:16px;margin-bottom:18px;}
.mb18{margin-bottom:18px;}
.span2{grid-column:span 2;}

/* ── CARD ── */
.card{background:var(--bg1);border:1px solid var(--bd);border-radius:8px;overflow:hidden;}
.card-hd{padding:10px 14px 8px;border-bottom:1px solid var(--bd);
  display:flex;align-items:center;justify-content:space-between;gap:8px;}
.card-title{font-family:var(--mono);font-size:8px;letter-spacing:2px;text-transform:uppercase;
  color:var(--ink2);font-weight:600;display:flex;align-items:center;gap:6px;}
.cdot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.card-meta{font-family:var(--mono);font-size:8px;color:var(--ink3);white-space:nowrap;}
.card-body{padding:13px 14px;}

/* ── ADMIN LEVEL SWITCHER ── */
.lvl-bar{display:flex;gap:0;}
.lvl-btn{padding:4px 10px;font-family:var(--mono);font-size:8px;letter-spacing:.8px;
  border:1px solid var(--bd2);background:var(--bg2);color:var(--ink3);
  cursor:pointer;transition:all .15s;text-transform:uppercase;}
.lvl-btn:first-child{border-radius:4px 0 0 4px;}
.lvl-btn:last-child{border-radius:0 4px 4px 0;border-left:none;}
.lvl-btn.on{background:var(--violet);color:#fff;border-color:var(--violet);}

/* ── PERMIT BARS ── */
.pbar-row{display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid var(--bd);}
.pbar-row:last-child{border-bottom:none;}
.pbar-lbl{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;
  color:var(--ink2);width:130px;flex-shrink:0;}
.pbar-track{flex:1;height:16px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.pbar-fill{height:100%;border-radius:3px;display:flex;align-items:center;
  justify-content:flex-end;padding-right:6px;transition:width .8s ease;}
.pbar-cnt{font-family:var(--mono);font-size:8px;font-weight:700;color:rgba(0,0,0,.85);}
.pbar-pct{font-family:var(--mono);font-size:9px;color:var(--ink3);width:38px;text-align:right;flex-shrink:0;}

/* ── ZONE BARS (illegal by zone_code) ── */
.zbar-row{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--bd);}
.zbar-row:last-child{border-bottom:none;}
.zbar-code{font-family:var(--mono);font-size:9px;font-weight:700;color:var(--ink);
  width:44px;flex-shrink:0;}
.zbar-track{flex:1;height:14px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.zbar-fill{height:100%;background:#f06080cc;border-radius:2px;transition:width .7s ease;
  display:flex;align-items:center;padding-left:6px;}
.zbar-lbl{font-family:var(--mono);font-size:8px;color:rgba(0,0,0,.8);font-weight:700;white-space:nowrap;}
.zbar-val{font-family:var(--mono);font-size:8px;color:var(--ink3);width:40px;text-align:right;flex-shrink:0;}

/* ── ADMIN BREAKDOWN TABLE ── */
.adm-scroll{max-height:280px;overflow-y:auto;scrollbar-width:thin;}
.adm-scroll::-webkit-scrollbar{width:3px;}
.adm-scroll::-webkit-scrollbar-thumb{background:var(--bd2);}
.adm-row{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--bd);}
.adm-row:last-child{border-bottom:none;}
.adm-name{font-family:var(--mono);font-size:8px;color:var(--ink2);
  width:110px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.adm-stacked{flex:1;display:flex;height:12px;border-radius:2px;overflow:hidden;gap:1px;}
.adm-seg{height:100%;transition:width .6s;}
.adm-total{font-family:var(--mono);font-size:8px;color:var(--ink3);
  width:40px;text-align:right;flex-shrink:0;}
.adm-illpct{font-family:var(--mono);font-size:8px;color:var(--rose);
  width:36px;text-align:right;flex-shrink:0;}

/* ── OVERVIEW CARDS ── */
.ov-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.ov-card{background:var(--bg1);border:1px solid var(--bd);border-radius:10px;
  overflow:hidden;cursor:pointer;transition:all .2s;}
.ov-card:hover{border-color:var(--bd2);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3);}
.ov-top{padding:13px 15px 10px;border-bottom:1px solid var(--bd);}
.ov-city-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.ov-cicon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.ov-cname{font-family:var(--mono);font-size:10px;font-weight:700;color:var(--ink);letter-spacing:.5px;}
.ov-cprov{font-family:var(--mono);font-size:7px;color:var(--ink3);margin-top:1px;}
.ov-sectors-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;
  border-radius:10px;font-family:var(--mono);font-size:7px;letter-spacing:.8px;margin-bottom:7px;}
.ov-total-row{display:flex;align-items:baseline;gap:5px;}
.ov-total{font-family:var(--mono);font-size:22px;font-weight:700;line-height:1;}
.ov-total-lbl{font-family:var(--mono);font-size:8px;color:var(--ink3);}
.ov-body{padding:10px 15px 13px;}
.ov-bar-wrap{margin-bottom:5px;}
.ov-bar-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
.ov-bar-name{font-family:var(--mono);font-size:8px;color:var(--ink3);}
.ov-bar-val{font-family:var(--mono);font-size:8px;font-weight:700;}
.ov-bar-track{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.ov-bar-fill{height:100%;border-radius:2px;transition:width .8s;}
.ov-foot{display:flex;justify-content:space-between;align-items:center;
  margin-top:9px;padding-top:8px;border-top:1px solid var(--bd);}
.ov-comp-lbl{font-family:var(--mono);font-size:7px;color:var(--ink3);letter-spacing:1px;text-transform:uppercase;}
.ov-comp-val{font-family:var(--mono);font-size:12px;font-weight:700;}
.ov-arrow{display:flex;align-items:center;gap:4px;font-family:var(--mono);font-size:8px;color:var(--teal);}

/* ── COMPARATIVE ROWS ── */
.cmp-row{display:flex;align-items:center;gap:10px;padding:5px 0;
  border-bottom:1px solid var(--bd);cursor:pointer;}
.cmp-row:hover .cmp-name{color:var(--ink);}
.cmp-row:last-child{border-bottom:none;}
.cmp-rank{font-family:var(--mono);font-size:8px;color:var(--ink3);width:16px;flex-shrink:0;}
.cmp-name{font-family:var(--mono);font-size:9px;font-weight:700;width:74px;flex-shrink:0;transition:color .15s;}
.cmp-stacked{flex:1;display:flex;height:14px;border-radius:3px;overflow:hidden;gap:1px;}
.cmp-seg{height:100%;transition:width .8s;}
.cmp-tot{font-family:var(--mono);font-size:8px;color:var(--ink2);width:40px;text-align:right;flex-shrink:0;}

/* ── RISK ROWS ── */
.risk-row{display:flex;align-items:center;gap:8px;padding:5px 0;
  border-bottom:1px solid var(--bd);cursor:pointer;}
.risk-row:last-child{border-bottom:none;}
.risk-row:hover .risk-name{color:var(--ink);}
.risk-rk{font-family:var(--mono);font-size:8px;color:var(--ink3);width:16px;}
.risk-name{font-family:var(--mono);font-size:9px;font-weight:700;width:74px;flex-shrink:0;transition:color .15s;}
.risk-track{flex:1;height:10px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.risk-fill{height:100%;border-radius:2px;transition:width .7s;}
.risk-pct{font-family:var(--mono);font-size:9px;font-weight:700;width:36px;text-align:right;}

/* ── MAP ── */
.map-pills{display:flex;gap:6px;padding:7px 14px;background:var(--bg2);border-top:1px solid var(--bd);flex-wrap:wrap;align-items:center;}
.mpill{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;
  font-family:var(--mono);font-size:7px;font-weight:700;letter-spacing:.8px;}
.mp-legal{background:#00d4b820;color:var(--teal);border:1px solid #00d4b850;}
.mp-illegal{background:#f0608020;color:var(--rose);border:1px solid #f0608050;}
.mp-exist{background:#f0c06020;color:var(--gold);border:1px solid #f0c06050;}
.map-hint{font-family:var(--mono);font-size:8px;color:var(--ink3);margin-left:auto;}
#allMapDiv{width:100%;height:380px;background:var(--bg2);}

/* ── RESPONSIVE ── */
@media(max-width:1100px){.kpi-row{grid-template-columns:repeat(3,1fr);}.ov-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:800px){.kpi-row{grid-template-columns:1fr 1fr;}.ov-grid{grid-template-columns:1fr 1fr;}.grid-21{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- ══ MASTHEAD ══ -->
<div class="masthead">
  <div class="mh-left">
    <div class="mh-title">Building Permit <em>Compliance</em></div>
    <div class="mh-sub">URBAN RWANDA · 2023–2025</div>
  </div>
  <div class="gkpi-row">
    <div class="gkpi c-teal">
      <div class="gkpi-lbl">Total Detected</div>
      <div class="gkpi-val" style="color:var(--teal)" id="g_total">—</div>
      <div class="gkpi-sub">Buildings analysed</div>
    </div>
    <div class="gkpi c-lime">
      <div class="gkpi-lbl">Legal — With Permit</div>
      <div class="gkpi-val" style="color:var(--lime)" id="g_legal">—</div>
      <div class="gkpi-sub">Verified compliant</div>
    </div>
    <div class="gkpi c-rose">
      <div class="gkpi-lbl">Illegal — Without Permit</div>
      <div class="gkpi-val" style="color:var(--rose)" id="g_illegal">—</div>
      <div class="gkpi-sub">Violations detected</div>
    </div>
    <div class="gkpi c-sky">
      <div class="gkpi-lbl">Compliance Rate</div>
      <div class="gkpi-val" style="color:var(--rose)" id="g_rate">—</div>
      <div class="gkpi-sub" id="g_rate_sub">—</div>
    </div>
  </div>
</div>

<!-- ══ STATUS ══ -->
<div class="sbar gone" id="sbar">
  <div class="sdot"></div><span id="stxt">Loading…</span>
</div>

<!-- ══ TABS ══ -->
<div class="tab-bar" id="tabBar">
  <button class="tab on" onclick="showTab('all')" id="tab_all">
    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    All Districts
    <span class="tbadge" id="badge_all">7</span>
  </button>
</div>

<!-- ══ MAIN ══ -->
<div class="main">

  <!-- ── ALL DISTRICTS VIEW ── -->
  <div class="city-view on" id="view_all">
    <div class="city-hd">
      <div class="city-icon" style="background:#0f2236;border:1px solid var(--bd2);">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
      </div>
      <div>
        <div class="city-name">All Districts</div>
        <div class="city-sub">7 URBAN AREAS ANALYSED</div>
      </div>
      <div class="hd-right">
        <div class="yr-bar" id="allYrBar">
          <button class="yr-btn on" onclick="setAllYr('both')">BOTH</button>
          <button class="yr-btn" onclick="setAllYr('2023')">2023</button>
          <button class="yr-btn" onclick="setAllYr('2025')">2025</button>
        </div>
      </div>
    </div>

    <!-- Overview city cards -->
    <div class="ov-grid" id="ovGrid"></div>

    <!-- Comparative + Risk side by side -->
    <div class="grid-2 mb18">
      <div class="card">
        <div class="card-hd">
          <div class="card-title"><div class="cdot" style="background:var(--teal)"></div>Permit Status — All Districts</div>
          <div class="card-meta" id="cmpMeta">—</div>
        </div>
        <div class="card-body" id="cmpBars"></div>
      </div>
      <div class="card">
        <div class="card-hd">
          <div class="card-title"><div class="cdot" style="background:var(--rose)"></div>Illegal Buildings Ranking</div>
          <div class="card-meta">% without permit</div>
        </div>
        <div class="card-body" id="riskBars"></div>
      </div>
    </div>

    <!-- All-cities map -->
    <div class="card mb18">
      <div class="card-hd">
        <div class="card-title"><div class="cdot" style="background:var(--violet)"></div>Permit Coverage Map — All Urban Areas</div>
        <div style="display:flex;gap:6px;">
          <span class="mpill mp-legal"><svg width="7" height="7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> LEGAL</span>
          <span class="mpill mp-illegal"><svg width="7" height="7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> ILLEGAL</span>
        </div>
      </div>
      <div>
        <div id="allMapDiv"></div>
        <div class="map-pills"><span class="map-hint" id="allMapHint">Loading map…</span></div>
      </div>
    </div>
  </div>

  <!-- ── CITY VIEWS (injected) ── -->
  <div id="cityViews"></div>
</div>

<script>
// ══════════════════════════════════════════════════════════════
//  CONFIG — add remaining 6 service URLs below Kayonza
// ══════════════════════════════════════════════════════════════
const WEBMAP_ID = 'b6f2526893bc45f681b1581a568a5422';
const ORG = 'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services';

const CITIES = [
  // ── Kayonza (confirmed URL)
  { id:'kayonza',   label:'Kayonza',   color:'#00d4b8', area:'Eastern Province',
    svc:`${ORG}/Building_Kayonza_urban/FeatureServer/0` },

  { id:'kirehe',    label:'Kirehe',    color:'#48b4f0', area:'Eastern Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Construction_Kirehe_Cities/FeatureServer/0' },

  { id:'nyagatare', label:'Nyagatare', color:'#a080f0', area:'Eastern Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Construction_Nyagatare_Cities/FeatureServer/0' },

  { id:'huye',      label:'Huye',      color:'#f0c060', area:'Southern Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Buildings_Huye_Cities/FeatureServer/0' },

  { id:'rubavu',    label:'Rubavu',    color:'#78d890', area:'Western Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Buildings_Rubavu_Cities/FeatureServer/0' },

  { id:'musanze',   label:'Musanze',   color:'#f06080', area:'Northern Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Building_Musanze_Cities/FeatureServer/0' },

  { id:'rusizi',    label:'Rusizi',    color:'#f08040', area:'Western Province',
    svc:'https://services7.arcgis.com/htgaiKX6RV2DDGgK/arcgis/rest/services/Buildings_Rusizi_Cities/FeatureServer/0' },
];

// ── legal_t field values
const LEGAL_KEYS = ['Legal','Illegal'];
const LEGAL = {
  'Legal':   { color:'#00d4b8' },
  'Illegal': { color:'#f06080' },
};

// ── Data store
const D = {};
CITIES.forEach(c => {
  D[c.id] = {
    total:0, loaded:false,
    byLegal:{}, byLegalYear:{'2023':{},'2025':{}},
    byZoneIllegal:{},
    bySector:{},
    byCell:{},
    byVillage:{},
  };
});

let allYr = 'both';
const cityYr  = {}; CITIES.forEach(c => cityYr[c.id]  = 'both');
const cityAdm = {}; CITIES.forEach(c => cityAdm[c.id] = 'sector');

const $ = id => document.getElementById(id);
const fmt  = n => (n||0).toLocaleString();
const fmtK = v => v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(1)+'K':String(v||0);
const pct  = (a,b) => b>0?(a/b*100).toFixed(1)+'%':'—';
const pctN = (a,b) => b>0?parseFloat((a/b*100).toFixed(1)):0;

// ── Legal key helpers
const LK_PERMIT  = 'Legal';
const LK_ILLEGAL = 'Illegal';

// ══════════════════════════════════════════════════════════════
//  TABS
// ══════════════════════════════════════════════════════════════
function buildTabs(){
  const bar = $('tabBar');
  CITIES.forEach(c => {
    const btn = document.createElement('button');
    btn.className='tab'; btn.id=`tab_${c.id}`;
    btn.onclick=()=>showTab(c.id);
    btn.innerHTML=`
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="${c.color}" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      ${c.label}
      <span class="tbadge" id="badge_${c.id}">—</span>`;
    bar.appendChild(btn);
  });
}

function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.city-view').forEach(v=>v.classList.remove('on'));
  $(`tab_${id}`)?.classList.add('on');
  $(`view_${id}`)?.classList.add('on');
  if(id!=='all') initCityMap(id);
}

// ══════════════════════════════════════════════════════════════
//  BUILD CITY HTML
// ══════════════════════════════════════════════════════════════
function buildCityViews(){
  const container=$('cityViews');
  CITIES.forEach(c=>{
    const div=document.createElement('div');
    div.className='city-view'; div.id=`view_${c.id}`;
    div.innerHTML=`
      <div class="city-hd">
        <div class="city-icon" style="background:${c.color}18;border:1px solid ${c.color}44;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${c.color}" stroke-width="1.5">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </div>
        <div>
          <div class="city-name">${c.label}</div>
          <div class="city-sub" id="csub_${c.id}">${c.area.toUpperCase()} · LOADING…</div>
        </div>
        <div class="hd-right">
          <div class="yr-bar">
            <button class="yr-btn on"  id="yrB_${c.id}"  onclick="setCityYr('${c.id}','both')">BOTH</button>
            <button class="yr-btn"     id="yr23_${c.id}" onclick="setCityYr('${c.id}','2023')">2023</button>
            <button class="yr-btn"     id="yr25_${c.id}" onclick="setCityYr('${c.id}','2025')">2025</button>
          </div>
        </div>
      </div>

      <!-- ── KPI CARDS ── -->
      <div class="kpi-row" style="grid-template-columns:repeat(4,1fr);">
        <div class="kcard c-teal">
          <div class="kcard-lbl">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Total Detected
          </div>
          <div class="kcard-val" style="color:${c.color}" id="kTot_${c.id}">—</div>
          <div class="kcard-sub" id="kTotS_${c.id}">Buildings analysed</div>
        </div>
        <div class="kcard c-lime">
          <div class="kcard-lbl">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--lime)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            Legal — With Permit
          </div>
          <div class="kcard-val" style="color:var(--lime)" id="kPermit_${c.id}">—</div>
          <div class="kcard-sub" id="kPermitS_${c.id}">Verified compliant</div>
        </div>
        <div class="kcard c-rose">
          <div class="kcard-lbl">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--rose)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            Illegal — Without Permit
          </div>
          <div class="kcard-val" style="color:var(--rose)" id="kIll_${c.id}">—</div>
          <div class="kcard-sub" id="kIllS_${c.id}">Violations detected</div>
        </div>
        <div class="kcard c-sky">
          <div class="kcard-lbl">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--sky)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Compliance Rate
          </div>
          <div class="kcard-val" style="color:var(--rose)" id="kRate_${c.id}">—</div>
          <div class="kcard-sub" id="kRateS_${c.id}">—</div>
        </div>
      </div>

      <!-- ── SECTION: ILLEGAL BY ZONE ── -->
      <div class="sec-label">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 2 17 12 22 22 17 22 7 12 2"/></svg>
        Illegal Buildings by Zone Code
      </div>
      <div class="grid-2 mb18">
        <div class="card">
          <div class="card-hd">
            <div class="card-title"><div class="cdot" style="background:var(--rose)"></div>Without Permit — Zone Distribution</div>
            <div class="card-meta" id="zmeta_${c.id}">—</div>
          </div>
          <div class="card-body" id="zoneBars_${c.id}"></div>
        </div>
        <div class="card">
          <div class="card-hd">
            <div class="card-title"><div class="cdot" style="background:var(--rose)"></div>Top Zones by Illegal Count</div>
            <div class="card-meta" id="ztop_${c.id}">top 10 zones</div>
          </div>
          <div class="card-body" id="zoneTop_${c.id}"></div>
        </div>
      </div>

      <!-- ── SECTION: BUILDINGS BY LEGALITY STATUS ── -->
      <div class="sec-label">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        Buildings by Legality Status
      </div>

      <!-- permit bars 2023 / 2025 + admin breakdown -->
      <div class="grid-21 mb18">
        <!-- Permit status bars by year -->
        <div class="card">
          <div class="card-hd">
            <div class="card-title"><div class="cdot" style="background:${c.color}"></div>Permit Status — 2023 vs 2025</div>            <div class="card-meta" id="pmeta_${c.id}">—</div>
          </div>
          <div class="card-body">
            <div style="font-family:var(--mono);font-size:7px;letter-spacing:1.5px;color:var(--sky);
              margin-bottom:7px;display:flex;align-items:center;gap:5px;">
              <svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              2023
            </div>
            <div id="pb23_${c.id}"></div>
            <div style="font-family:var(--mono);font-size:7px;letter-spacing:1.5px;color:var(--teal);
              margin:12px 0 7px;display:flex;align-items:center;gap:5px;">
              <svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              2025
            </div>
            <div id="pb25_${c.id}"></div>
          </div>
        </div>

        <!-- Admin level breakdown -->
        <div class="card">
          <div class="card-hd">
            <div class="card-title"><div class="cdot" style="background:var(--violet)"></div>By Administrative Level</div>
            <div class="lvl-bar" id="lvl_${c.id}">
              <button class="lvl-btn on"  onclick="setAdm('${c.id}','sector')" >Sector</button>
              <button class="lvl-btn"     onclick="setAdm('${c.id}','cell')"   >Cell</button>
              <button class="lvl-btn"     onclick="setAdm('${c.id}','village')">Village</button>
            </div>
          </div>
          <div class="card-body">
            <div class="adm-scroll" id="admBars_${c.id}"></div>
          </div>
        </div>
      </div>

      <!-- ── MAP ── -->
      <div class="card">
        <div class="card-hd">
          <div class="card-title"><div class="cdot" style="background:${c.color}"></div>${c.label} — Building Permit Map</div>
          <div style="display:flex;gap:6px;">
            <span class="mpill mp-legal"><svg width="7" height="7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> LEGAL</span>
            <span class="mpill mp-illegal"><svg width="7" height="7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> ILLEGAL</span>
          </div>
        </div>
        <div>
          <div id="mapDiv_${c.id}" style="width:100%;height:380px;background:var(--bg2);"></div>
          <div class="map-pills"><span class="map-hint" id="mhint_${c.id}">Loading map…</span></div>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

// ══════════════════════════════════════════════════════════════
//  DATA FETCH
// ══════════════════════════════════════════════════════════════
async function qStat(svc,where,groupBy){
  const body=new URLSearchParams();
  body.set('where',where||'1=1');
  body.set('groupByFieldsForStatistics',groupBy);
  body.set('outStatistics','[{"statisticType":"count","onStatisticField":"OBJECTID","outStatisticFieldName":"cnt"}]');
  body.set('returnGeometry','false');
  body.set('f','json');
  try{
    const r=await fetch(svc+'/query',{method:'POST',body,
      headers:{'Content-Type':'application/x-www-form-urlencoded'}});
    const j=await r.json();
    if(j.error) throw new Error(j.error.message);
    return j.features||[];
  }catch(e){console.warn('qStat',groupBy,e.message);return[];}
}

async function loadCity(city){
  const d=D[city.id];
  setStatus(`${city.label} · permit status…`);

  // 1) legal_t × year_t
  const r1=await qStat(city.svc,'1=1','legal_t,year_t');
  r1.forEach(f=>{
    const lt=f.attributes.legal_t||'Unknown';
    const yr=String(f.attributes.year_t||'');
    const cnt=f.attributes.cnt||0;
    d.byLegal[lt]=(d.byLegal[lt]||0)+cnt;
    if(!d.byLegalYear[yr]) d.byLegalYear[yr]={};
    d.byLegalYear[yr][lt]=(d.byLegalYear[yr][lt]||0)+cnt;
  });
  d.total=Object.values(d.byLegal).reduce((s,v)=>s+v,0);
  setStatus(`${city.label} · zone analysis…`);
  const illWhere=`legal_t='Illegal'`;
  const r2=await qStat(city.svc,illWhere,'zone_code');
  r2.forEach(f=>{
    const zc=f.attributes.zone_code||'Unknown';
    const cnt=f.attributes.cnt||0;
    d.byZoneIllegal[zc]=(d.byZoneIllegal[zc]||0)+cnt;
  });

  // 3) sector × legal_t
  setStatus(`${city.label} · sectors…`);
  const r3=await qStat(city.svc,'1=1','sector,legal_t');
  r3.forEach(f=>{
    const sec=f.attributes.sector||'Unknown';
    const lt=f.attributes.legal_t||'Unknown';
    const cnt=f.attributes.cnt||0;
    if(!d.bySector[sec]) d.bySector[sec]={};
    d.bySector[sec][lt]=(d.bySector[sec][lt]||0)+cnt;
  });

  // 4) cell × legal_t
  setStatus(`${city.label} · cells…`);
  const r4=await qStat(city.svc,'1=1','cell,legal_t');
  r4.forEach(f=>{
    const cel=f.attributes.cell||'Unknown';
    const lt=f.attributes.legal_t||'Unknown';
    const cnt=f.attributes.cnt||0;
    if(!d.byCell[cel]) d.byCell[cel]={};
    d.byCell[cel][lt]=(d.byCell[cel][lt]||0)+cnt;
  });

  // 5) village × legal_t
  setStatus(`${city.label} · villages…`);
  const r5=await qStat(city.svc,'1=1','village,legal_t');
  r5.forEach(f=>{
    const vil=f.attributes.village||'Unknown';
    const lt=f.attributes.legal_t||'Unknown';
    const cnt=f.attributes.cnt||0;
    if(!d.byVillage[vil]) d.byVillage[vil]={};
    d.byVillage[vil][lt]=(d.byVillage[vil][lt]||0)+cnt;
  });

  d.loaded=true;
  $(`badge_${city.id}`).textContent=fmtK(d.total);
  renderCity(city);
  renderAllView();
  updateGlobalKpis();
}

// ══════════════════════════════════════════════════════════════
//  RENDER CITY
// ══════════════════════════════════════════════════════════════
function setCityYr(id,yr){
  cityYr[id]=yr;
  ['B','23','25'].forEach(s=>{
    const b=$(`yr${s}_${id}`);
    if(b) b.classList.toggle('on',
      (s==='B'&&yr==='both')||(s==='23'&&yr==='2023')||(s==='25'&&yr==='2025'));
  });
  renderCity(CITIES.find(c=>c.id===id));
}

function setAdm(id,lvl){
  cityAdm[id]=lvl;
  const bar=$(`lvl_${id}`);
  if(bar) bar.querySelectorAll('.lvl-btn').forEach(b=>{
    b.classList.toggle('on',b.textContent.toLowerCase()===lvl);
  });
  renderAdmBars(id);
}

function getLegal(id,lt){
  const d=D[id]; const yr=cityYr[id];
  if(yr==='both') return d.byLegal[lt]||0;
  return d.byLegalYear[yr]?.[lt]||0;
}

function renderCity(city){
  const id=city.id; const d=D[id];
  if(!d.loaded) return;

  const permit = getLegal(id,LK_PERMIT);
  const ill    = getLegal(id,LK_ILLEGAL);
  const tot    = permit+ill||1;
  const yr     = cityYr[id];
  const secCnt = Object.keys(d.bySector).length;

  // subtitle
  $(`csub_${id}`).textContent=
    `${city.area.toUpperCase()} · ${secCnt} SECTORS · ${fmt(tot)} BUILDINGS · ${yr==='both'?'2023 & 2025':yr}`;

  // KPIs
  $(`kTot_${id}`).textContent    = fmtK(tot);
  $(`kTotS_${id}`).textContent   = yr==='both'?'2023 & 2025':yr;
  $(`kPermit_${id}`).textContent = fmtK(permit);
  $(`kPermitS_${id}`).textContent= `${pct(permit,tot)} of total`;
  $(`kIll_${id}`).textContent    = fmtK(ill);
  $(`kIllS_${id}`).textContent   = `${pct(ill,tot)} violations`;
  $(`kRate_${id}`).textContent   = pct(permit,permit+ill);
  $(`kRateS_${id}`).textContent  = `${fmt(permit)} of ${fmt(permit+ill)} assessed`;

  // Permit bars by year
  $(`pmeta_${id}`).textContent=`${fmt(tot)} buildings`;
  renderPermitBars(`pb23_${id}`,d.byLegalYear['2023']||{});
  renderPermitBars(`pb25_${id}`,d.byLegalYear['2025']||{});

  // Zone illegal bars
  renderZoneBars(id);

  // Admin breakdown
  renderAdmBars(id);
}

function renderPermitBars(cid,data){
  const c=$(cid); if(!c) return;
  const tot=LEGAL_KEYS.reduce((s,lt)=>s+(data[lt]||0),0)||1;
  c.innerHTML=LEGAL_KEYS.map(lt=>{
    const cnt=data[lt]||0;
    const w=pctN(cnt,tot);
    const col=LEGAL[lt]?.color||'#5a8aaa';
    const icon=lt.includes('Permit')&&!lt.includes('Illegal')
      ?`<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`
      :lt.includes('Illegal')
      ?`<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`
      :`<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
    return `<div class="pbar-row">
      <span class="pbar-lbl" style="color:${col};">${icon}&nbsp;${lt}</span>
      <div class="pbar-track">
        <div class="pbar-fill" style="width:${w}%;background:${col};">
          <span class="pbar-cnt">${fmtK(cnt)}</span>
        </div>
      </div>
      <span class="pbar-pct">${pct(cnt,tot)}</span>
    </div>`;
  }).join('');
}

function renderZoneBars(id){
  const d=D[id];
  const zc=$(`zoneBars_${id}`);
  const zt=$(`zoneTop_${id}`);
  if(!zc||!zt) return;

  const items=Object.entries(d.byZoneIllegal).sort((a,b)=>b[1]-a[1]);
  const totalIll=items.reduce((s,[,v])=>s+v,0)||1;
  $(`zmeta_${id}`).textContent=`${items.length} zones · ${fmt(totalIll)} illegal`;

  // Left: proportional bars (top 12)
  const max=items[0]?.[1]||1;
  zc.innerHTML=items.slice(0,12).map(([zcode,cnt])=>{
    const w=pctN(cnt,max);
    const pw=pctN(cnt,totalIll);
    return `<div class="zbar-row">
      <span class="zbar-code">${zcode}</span>
      <div class="zbar-track">
        <div class="zbar-fill" style="width:${w}%;">
          <span class="zbar-lbl">${fmtK(cnt)}</span>
        </div>
      </div>
      <span class="zbar-val">${pw.toFixed(1)}%</span>
    </div>`;
  }).join('');

  // Right: top 10 ranked list with counts
  zt.innerHTML=items.slice(0,10).map(([zcode,cnt],i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--bd);">
      <span style="font-family:var(--mono);font-size:8px;color:var(--ink3);width:16px;">${i+1}</span>
      <span style="font-family:var(--mono);font-size:10px;font-weight:700;color:var(--rose);width:44px;">${zcode}</span>
      <div style="flex:1;height:10px;background:var(--bg3);border-radius:2px;overflow:hidden;">
        <div style="width:${pctN(cnt,max)}%;height:100%;background:#f06080cc;border-radius:2px;"></div>
      </div>
      <span style="font-family:var(--mono);font-size:9px;color:var(--ink2);width:44px;text-align:right;">${fmtK(cnt)}</span>
    </div>`).join('');
}

function renderAdmBars(id){
  const d=D[id];
  const c=$(`admBars_${id}`); if(!c) return;
  const lvl=cityAdm[id]||'sector';
  const src=lvl==='sector'?d.bySector:lvl==='cell'?d.byCell:d.byVillage;
  const items=Object.entries(src).map(([name,lts])=>{
    const tot=Object.values(lts).reduce((s,v)=>s+v,0);
    return{name,lts,tot};
  }).sort((a,b)=>b.tot-a.tot);

  const max=items[0]?.tot||1;
  c.innerHTML=items.slice(0,30).map(({name,lts,tot})=>{
    const permit=lts[LK_PERMIT]||0;
    const ill=lts[LK_ILLEGAL]||0;
    const wP=pctN(permit,max); const wI=pctN(ill,max);
    const illPct=pctN(ill,permit+ill);
    const illCol=illPct>50?'var(--rose)':illPct>25?'var(--gold)':'var(--lime)';
    return `<div class="adm-row">
      <span class="adm-name" title="${name}">${name}</span>
      <div class="adm-stacked">
        <div class="adm-seg" style="width:${wP}%;background:#00d4b8cc;"></div>
        <div class="adm-seg" style="width:${wI}%;background:#f06080cc;"></div>
      </div>
      <span class="adm-total">${fmtK(tot)}</span>
      <span class="adm-illpct" style="color:${illCol};">${illPct.toFixed(0)}%</span>
    </div>`;
  }).join('');

  // Update header meta
  const hd=document.querySelector(`#view_${id} .card-meta[id="smeta_${id}"]`);
  // set via data-bound element if exists
}

// ══════════════════════════════════════════════════════════════
//  ALL VIEW
// ══════════════════════════════════════════════════════════════
function setAllYr(yr){
  allYr=yr;
  document.querySelectorAll('#allYrBar .yr-btn').forEach(b=>{
    b.classList.toggle('on',
      (b.textContent==='BOTH'&&yr==='both')||
      (b.textContent==='2023'&&yr==='2023')||
      (b.textContent==='2025'&&yr==='2025'));
  });
  renderAllView();
}

function getAll(city,lt){
  const d=D[city.id];
  if(allYr==='both') return d.byLegal[lt]||0;
  return d.byLegalYear[allYr]?.[lt]||0;
}

function renderAllView(){
  renderOvCards();
  renderCmpBars();
  renderRiskBars();
}

function renderOvCards(){
  const c=$('ovGrid'); if(!c) return;
  c.innerHTML=CITIES.map(city=>{
    const d=D[city.id];
    const permit=getAll(city,LK_PERMIT);
    const ill   =getAll(city,LK_ILLEGAL);
    const tot   =permit+ill||1;
    const rate  =pctN(permit,permit+ill);
    const rateCol=rate>60?'var(--lime)':rate>30?'var(--gold)':'var(--rose)';
    const secCnt=Object.keys(d.bySector).length;
    return `<div class="ov-card" onclick="showTab('${city.id}')">
      <div class="ov-top">
        <div class="ov-city-row">
          <div class="ov-cicon" style="background:${city.color}18;border:1px solid ${city.color}44;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${city.color}" stroke-width="1.5">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <div>
            <div class="ov-cname">${city.label}</div>
            <div class="ov-cprov">${city.area}</div>
          </div>
        </div>
        <div class="ov-sectors-pill" style="background:${city.color}12;border:1px solid ${city.color}30;color:${city.color};">
          <svg width="7" height="7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/></svg>
          ${secCnt} urbanized sectors
        </div>
        <div class="ov-total-row">
          <div class="ov-total" style="color:${city.color};">${fmtK(tot)}</div>
          <div class="ov-total-lbl">buildings</div>
        </div>
      </div>
      <div class="ov-body">
        ${[[LK_PERMIT,'#00d4b8',permit],[LK_ILLEGAL,'#f06080',ill]].map(([lbl,col,cnt])=>`
          <div class="ov-bar-wrap">
            <div class="ov-bar-hd">
              <span class="ov-bar-name">${lbl}</span>
              <span class="ov-bar-val" style="color:${col};">${fmtK(cnt)}</span>
            </div>
            <div class="ov-bar-track">
              <div class="ov-bar-fill" style="width:${pctN(cnt,tot)}%;background:${col};"></div>
            </div>
          </div>`).join('')}
        <div class="ov-foot">
          <div>
            <div class="ov-comp-lbl">Compliance Rate</div>
            <div class="ov-comp-val" style="color:${rateCol};">${rate.toFixed(1)}%</div>
          </div>
          <div class="ov-arrow">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
            View analysis
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderCmpBars(){
  const c=$('cmpBars'); if(!c) return;
  const items=CITIES.map(city=>{
    const p=getAll(city,LK_PERMIT);
    const i=getAll(city,LK_ILLEGAL);
    return{city,p,i,tot:p+i||1};
  }).sort((a,b)=>b.tot-a.tot);
  const maxT=items[0]?.tot||1;
  $('cmpMeta').textContent=allYr==='both'?'2023 & 2025':allYr;
  c.innerHTML=items.map(({city,p,i,tot},idx)=>`
    <div class="cmp-row" onclick="showTab('${city.id}')">
      <span class="cmp-rank">${idx+1}</span>
      <span class="cmp-name" style="color:${city.color};">${city.label}</span>
      <div class="cmp-stacked">
        <div class="cmp-seg" style="width:${pctN(p,maxT)}%;background:#00d4b8cc;" title="Legal: ${fmtK(p)}"></div>
        <div class="cmp-seg" style="width:${pctN(i,maxT)}%;background:#f06080cc;" title="Illegal: ${fmtK(i)}"></div>
      </div>
      <span class="cmp-tot">${fmtK(tot)}</span>
    </div>`).join('');
}

function renderRiskBars(){
  const c=$('riskBars'); if(!c) return;
  const items=CITIES.map(city=>{
    const p=getAll(city,LK_PERMIT);
    const i=getAll(city,LK_ILLEGAL);
    return{city,i,p,r:pctN(i,p+i)};
  }).sort((a,b)=>b.r-a.r);
  const maxR=items[0]?.r||1;
  c.innerHTML=items.map(({city,r},idx)=>{
    const col=r>50?'var(--rose)':r>25?'var(--gold)':'var(--lime)';
    return `<div class="risk-row" onclick="showTab('${city.id}')">
      <span class="risk-rk">${idx+1}</span>
      <span class="risk-name" style="color:${city.color};">${city.label}</span>
      <div class="risk-track">
        <div class="risk-fill" style="width:${(r/maxR*100).toFixed(1)}%;background:${col}cc;"></div>
      </div>
      <span class="risk-pct" style="color:${col};">${r.toFixed(1)}%</span>
    </div>`;
  }).join('');
}

function updateGlobalKpis(){
  let tot=0,permit=0,ill=0;
  CITIES.forEach(c=>{
    tot   +=D[c.id].total||0;
    permit+=(D[c.id].byLegal[LK_PERMIT]||0);
    ill   +=(D[c.id].byLegal[LK_ILLEGAL]||0);
  });
  const rate=pctN(permit,permit+ill);
  $('g_total').textContent =fmtK(tot);
  $('g_legal').textContent =fmtK(permit);
  $('g_illegal').textContent=fmtK(ill);
  $('g_rate').textContent  =rate.toFixed(1)+'%';
  $('g_rate_sub').textContent=`${fmt(permit)} of ${fmt(permit+ill)}`;
}

function setStatus(txt){
  const b=$('sbar');
  if(txt){b.classList.remove('gone');$('stxt').textContent=txt.toUpperCase();}
  else b.classList.add('gone');
}

// ══════════════════════════════════════════════════════════════
//  ARCGIS
// ══════════════════════════════════════════════════════════════
let arcReady=false; const mapInst={};

function loadArcGIS(cb){
  if(arcReady){cb();return;}
  const lnk=document.createElement('link');lnk.rel='stylesheet';
  lnk.href='https://js.arcgis.com/4.29/esri/themes/dark/main.css';
  document.head.appendChild(lnk);
  const s=document.createElement('script');s.src='https://js.arcgis.com/4.29/';
  s.onload=()=>setTimeout(()=>{arcReady=true;cb();},200);
  document.head.appendChild(s);
}

const permitRenderer={
  type:'unique-value',field:'legal_t',
  defaultSymbol:{type:'simple-fill',color:[42,69,96,160],outline:{color:[255,255,255,20],width:.2}},
  uniqueValueInfos:[
    {value:'Legal',   symbol:{type:'simple-fill',color:'#00d4b8bb',outline:{color:'#00d4b8',width:.6}}},
    {value:'Illegal', symbol:{type:'simple-fill',color:'#f06080bb',outline:{color:'#f06080',width:.6}}},
  ]
};

const popupTpl={
  title:'{legal_t}',
  content:'<b>Zone:</b> {zone_code}<br><b>District:</b> {district}<br><b>Sector:</b> {sector}<br><b>Cell:</b> {cell}<br><b>Village:</b> {village}<br><b>Year:</b> {year_t}<br><b>UPI:</b> {upi}'
};

function initAllMap(){
  loadArcGIS(()=>{
    require(['esri/WebMap','esri/views/MapView','esri/layers/FeatureLayer',
             'esri/widgets/Home','esri/widgets/Legend','esri/widgets/Expand'],
    function(WebMap,MapView,FeatureLayer,Home,Legend,Expand){
      const layers=CITIES.map(c=>new FeatureLayer({url:c.svc,renderer:permitRenderer,popupTemplate:popupTpl,title:c.label}));
      const wm=new WebMap({portalItem:{id:WEBMAP_ID}});
      layers.forEach(l=>wm.add(l));
      const view=new MapView({container:'allMapDiv',map:wm,center:[29.87,-1.94],zoom:8,
        ui:{components:['zoom','attribution']}});
      view.ui.add(new Home({view}),'top-left');
      view.ui.add(new Expand({view,content:new Legend({view}),expandIcon:'legend',expanded:false}),'bottom-left');
      view.when(()=>{$('allMapHint').textContent='Click any building to see permit status · All 7 urban areas';});
    });
  });
}

function initCityMap(id){
  if(mapInst[id]) return; mapInst[id]=true;
  const city=CITIES.find(c=>c.id===id); if(!city) return;
  loadArcGIS(()=>{
    require(['esri/WebMap','esri/views/MapView','esri/layers/FeatureLayer',
             'esri/widgets/Home','esri/widgets/Search','esri/widgets/Legend',
             'esri/widgets/Expand','esri/widgets/ScaleBar'],
    function(WebMap,MapView,FeatureLayer,Home,Search,Legend,Expand,ScaleBar){
      const layer=new FeatureLayer({url:city.svc,renderer:permitRenderer,popupTemplate:popupTpl,title:`${city.label} Buildings`});
      const wm=new WebMap({portalItem:{id:WEBMAP_ID}});
      wm.add(layer);
      const view=new MapView({container:`mapDiv_${id}`,map:wm,zoom:13,
        ui:{components:['zoom','attribution']},
        popup:{dockEnabled:true,dockOptions:{position:'bottom-right',breakpoint:false}}});
      view.ui.add(new Home({view}),'top-left');
      view.ui.add(new Search({view}),'top-right');
      view.ui.add(new ScaleBar({view,unit:'metric'}),'bottom-right');
      view.ui.add(new Expand({view,content:new Legend({view,layerInfos:[{layer,title:'Permit Status'}]}),
        expandIcon:'legend',expanded:true}),'bottom-left');
      view.when(()=>$(`mhint_${id}`).textContent=`${city.label} · click a building for zone, sector, cell, village details`);
    });
  });
}

// ══════════════════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════════════════
buildTabs();
buildCityViews();
renderAllView();
Promise.all(CITIES.map(c=>loadCity(c))).then(()=>setStatus(null)).catch(()=>setStatus(null));
initAllMap();
window.addEventListener('resize',()=>renderAllView());
</script>
</body>
</html>
